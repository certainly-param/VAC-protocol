services:
  sidecar:
    build:
      context: .
      dockerfile: sidecar/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VAC_ROOT_PUBLIC_KEY=${VAC_ROOT_PUBLIC_KEY}
      - VAC_API_KEY=${VAC_API_KEY:-demo-api-key}
      - VAC_UPSTREAM_URL=http://demo-api:8080
      - VAC_CONTROL_PLANE_URL=http://control-plane:8081
      - VAC_HEARTBEAT_INTERVAL_SECS=60
    depends_on:
      - control-plane
      - demo-api

  control-plane:
    build:
      context: .
      dockerfile: control-plane/Dockerfile
    ports:
      - "8081:8081"

  demo-api:
    build:
      context: .
      dockerfile: demo-api/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DEMO_API_KEY=${VAC_API_KEY:-demo-api-key}

  # Optional: Python/FastAPI demo API (same endpoints). Use with:
  #   VAC_UPSTREAM_URL=http://demo-api-python:8080 docker-compose --profile fastapi up
  demo-api-python:
    build:
      context: .
      dockerfile: demo-api-python/Dockerfile
    ports:
      - "8082:8080"
    environment:
      - DEMO_API_KEY=${VAC_API_KEY:-demo-api-key}
    profiles:
      - fastapi
